<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Aceptar o Rechazar Viaje</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; }
    .info { margin-bottom: 15px; padding: 15px; background: #fff; border: 1px solid #ccc; border-radius: 5px; }
    button { width: 48%; padding: 10px; margin-top: 10px; }
    .btns { display: flex; justify-content: space-between; }
    #map { width: 100%; height: 300px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Solicitud de Viaje</h1>

  <div id="map"></div>
  <div id="infoSolicitud"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const firebaseConfig = { /* TU CONFIGURACIÓN FIREBASE */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const placas = localStorage.getItem("placas_chat");
    const refSolicitud = db.ref("solicitudes_viaje/" + placas);

    let map;
    let alumnoMarker;

    refSolicitud.once("value", snapshot => {
      const solicitud = snapshot.val();
      if (solicitud) {
        const infoDiv = document.getElementById("infoSolicitud");
        infoDiv.innerHTML = `
          <div class="info">
            <strong>Alumno:</strong> ${solicitud.alumno} <br>
            <strong>Teléfono:</strong> ${solicitud.telefono} <br>
            <strong>Notas:</strong> ${solicitud.notas}
            <div class="btns">
              <button onclick="aceptarViaje()">Aceptar</button>
              <button onclick="rechazarViaje()">Rechazar</button>
            </div>
          </div>
        `;

        db.ref("alumnos_ubicaciones/" + solicitud.alumno).once("value", snapUbicacion => {
          const ubicacion = snapUbicacion.val();
          if (ubicacion && ubicacion.lat && ubicacion.lng) {
            map = L.map('map').setView([ubicacion.lat, ubicacion.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            alumnoMarker = L.marker([ubicacion.lat, ubicacion.lng]).addTo(map)
              .bindPopup("Ubicación del alumno")
              .openPopup();
          } else {
            document.getElementById("map").innerHTML = "No se encontró la ubicación del alumno.";
          }
        });
      } else {
        document.getElementById("infoSolicitud").innerHTML = "No tienes solicitudes de viaje por ahora.";
        document.getElementById("map").style.display = "none";
      }
    });

    function aceptarViaje() {
      window.location.href = "chat_conductor.html";
    }

    function rechazarViaje() {
      db.ref("solicitudes_viaje/" + placas).remove();
      alert("Solicitud rechazada.");
      window.location.href = "pagina_conductor.html";
    }
  </script>
</body>
</html>

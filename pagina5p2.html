<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Alumno</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background-color: #ffffff; }
    h1 { text-align: center; }
    input, textarea, button { width: 100%; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Registro de Alumno</h1>

  <form id="registroAlumno">
    <input type="text" id="nombre" placeholder="Nombre completo" required>
    <input type="tel" id="telefono" placeholder="Número de contacto" pattern="\d{10}" required>
    <textarea id="notas" placeholder="Notas adicionales (opcional)"></textarea>
    <button type="button" id="btnUbicacion">Compartir mi ubicación</button>
    <button type="submit" id="btnSolicitar" disabled>Solicitar Coche</button>
    <div id="estadoUbicacion" style="margin-top:10px;color:#388e3c;"></div>
  </form>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = { /* TU CONFIGURACIÓN FIREBASE */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let ubicacionAlumno = null;
    let watchId = null;

    document.getElementById("btnUbicacion").addEventListener("click", function() {
      const estado = document.getElementById("estadoUbicacion");
      estado.textContent = "Comprobando permisos...";

      navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
        if (result.state === 'granted' || result.state === 'prompt') {
          iniciarUbicacion();
        } else {
          alert("Debes habilitar la ubicación en la configuración de tu app o navegador.");
        }
      }).catch(() => {
        iniciarUbicacion(); // Si el navegador no soporta la API de permisos
      });

      function iniciarUbicacion() {
        estado.textContent = "Obteniendo ubicación en tiempo real...";
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
        }
        watchId = navigator.geolocation.watchPosition(function(pos) {
          ubicacionAlumno = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          estado.textContent = `Ubicación actualizada: Lat ${ubicacionAlumno.lat.toFixed(5)}, Lng ${ubicacionAlumno.lng.toFixed(5)}`;
          document.getElementById("btnSolicitar").disabled = false;

          const nombre = document.getElementById("nombre").value;
          if (nombre) {
            db.ref("alumnos_ubicaciones/" + nombre).set(ubicacionAlumno);
          }
        }, function() {
          estado.textContent = "No se pudo obtener la ubicación. Permite el acceso a la ubicación e inténtalo de nuevo.";
        }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
      }
    });

    document.getElementById("registroAlumno").addEventListener("submit", function(event) {
      event.preventDefault();
      const nombre = document.getElementById("nombre").value;
      const telefono = document.getElementById("telefono").value;
      const notas = document.getElementById("notas").value;

      if (!ubicacionAlumno) {
        document.getElementById("estadoUbicacion").textContent = "Primero comparte tu ubicación.";
        return;
      }

      localStorage.setItem("alumno_datos", JSON.stringify({ nombre, telefono, notas }));

      db.ref("alumnos_ubicaciones/" + nombre).set(ubicacionAlumno, function(error) {
        if (error) {
          document.getElementById("estadoUbicacion").textContent = "Error al guardar la ubicación. Intenta de nuevo.";
        } else {
          if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
          }
          window.location.href = "buscar_conductores.html";
        }
      });
    });
  </script>
</body>
</html>

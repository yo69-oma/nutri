<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscar Conductores Cercanos</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background-color: #f0f0f0; }
    h1 { text-align: center; }
    ul { padding-left: 0; list-style: none; }
    li { margin-bottom: 10px; padding: 10px; background-color: #fff; border-radius: 5px; cursor: pointer; border: 1px solid #ccc; }
    #map { width: 100%; height: 350px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Conductores Cercanos</h1>

  <div id="map"></div>
  <ul id="listaConductores"></ul>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const firebaseConfig = { /* TU CONFIGURACIÓN FIREBASE */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map;
    let alumnoMarker;
    let conductorMarkers = {};

    navigator.geolocation.getCurrentPosition(pos => {
      const alumnoLat = pos.coords.latitude;
      const alumnoLng = pos.coords.longitude;

      map = L.map('map').setView([alumnoLat, alumnoLng], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      alumnoMarker = L.marker([alumnoLat, alumnoLng]).addTo(map)
        .bindPopup("Tu ubicación")
        .openPopup();

      db.ref("conductores_disponibles").on("value", snapshot => {
        const lista = document.getElementById("listaConductores");
        lista.innerHTML = "";
        const datos = snapshot.val();

        // Eliminar marcadores anteriores
        for (const key in conductorMarkers) {
          map.removeLayer(conductorMarkers[key]);
        }
        conductorMarkers = {};

        for (const placas in datos) {
          const c = datos[placas];
          const dist = calcularDistancia(alumnoLat, alumnoLng, c.lat, c.lng);
          const li = document.createElement("li");
          li.textContent = `${c.nombre} (${c.placas}) - ${dist.toFixed(2)} km`;
          li.onclick = () => {
            const datosAlumno = JSON.parse(localStorage.getItem("alumno_datos"));
            firebase.database().ref("solicitudes_viaje/" + c.placas).set({
              alumno: datosAlumno.nombre,
              telefono: datosAlumno.telefono,
              notas: datosAlumno.notas
            });
            localStorage.setItem("placas_chat", c.placas);
            window.location.href = "chat_alumno.html";
          };
          lista.appendChild(li);

          if (c.lat && c.lng) {
            const marker = L.marker([c.lat, c.lng]).addTo(map)
              .bindPopup(`${c.nombre} (${c.placas})`);
            conductorMarkers[placas] = marker;
          }
        }
      });

    }, () => alert("No se pudo obtener tu ubicación"));

    function calcularDistancia(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
  </script>
</body>
</html>
